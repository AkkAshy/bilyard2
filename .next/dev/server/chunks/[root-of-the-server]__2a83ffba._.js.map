{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\nimport { withAccelerate } from \"@prisma/extension-accelerate\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: ReturnType<typeof createPrismaClient> | undefined;\n};\n\nfunction createPrismaClient() {\n  return new PrismaClient().$extends(withAccelerate());\n}\n\nexport const prisma = globalForPrisma.prisma ?? createPrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,kBAAkB;AAIxB,SAAS;IACP,OAAO,IAAI,sMAAY,GAAG,QAAQ,CAAC,IAAA,wLAAc;AACnD;AAEO,MAAM,SAAS,gBAAgB,MAAM,IAAI;AAEhD,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/app/api/esp/status/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\n\n// GET /api/esp/status - получить статус столов для ESP\nexport async function GET(request: NextRequest) {\n  try {\n    // Проверяем авторизацию ESP\n    const authHeader = request.headers.get(\"authorization\");\n    const espSecret = process.env.ESP_SECRET;\n\n    if (!authHeader || authHeader !== `Bearer ${espSecret}`) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    // Получаем все столы с активными сессиями\n    const tables = await prisma.billiardTable.findMany({\n      where: { isActive: true },\n      include: {\n        sessions: {\n          where: { status: \"ACTIVE\" },\n          take: 1,\n        },\n      },\n      orderBy: { id: \"asc\" },\n    });\n\n    // Проверяем истекшие сессии и обновляем их статус\n    const now = new Date();\n    for (const table of tables) {\n      const activeSession = table.sessions[0];\n      if (activeSession && activeSession.duration) {\n        const endTime = new Date(\n          activeSession.startedAt.getTime() + activeSession.duration * 60000\n        );\n        if (now > endTime) {\n          // Сессия истекла - обновляем статус\n          await prisma.session.update({\n            where: { id: activeSession.id },\n            data: {\n              status: \"EXPIRED\",\n              endedAt: endTime,\n              actualDuration: activeSession.duration,\n            },\n          });\n          // Удаляем из активных\n          table.sessions = [];\n        }\n      }\n    }\n\n    // Формируем ответ для ESP\n    const response = {\n      tables: tables.map((table) => ({\n        id: table.id,\n        gpioPin: table.gpioPin,\n        light: table.sessions.length > 0, // true если есть активная сессия\n      })),\n      timestamp: Date.now(),\n    };\n\n    return NextResponse.json(response);\n  } catch (error) {\n    console.error(\"Error fetching ESP status:\", error);\n    return NextResponse.json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAGO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,4BAA4B;QAC5B,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;QACvC,MAAM,YAAY,QAAQ,GAAG,CAAC,UAAU;QAExC,IAAI,CAAC,cAAc,eAAe,CAAC,OAAO,EAAE,WAAW,EAAE;YACvD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,0CAA0C;QAC1C,MAAM,SAAS,MAAM,gIAAM,CAAC,aAAa,CAAC,QAAQ,CAAC;YACjD,OAAO;gBAAE,UAAU;YAAK;YACxB,SAAS;gBACP,UAAU;oBACR,OAAO;wBAAE,QAAQ;oBAAS;oBAC1B,MAAM;gBACR;YACF;YACA,SAAS;gBAAE,IAAI;YAAM;QACvB;QAEA,kDAAkD;QAClD,MAAM,MAAM,IAAI;QAChB,KAAK,MAAM,SAAS,OAAQ;YAC1B,MAAM,gBAAgB,MAAM,QAAQ,CAAC,EAAE;YACvC,IAAI,iBAAiB,cAAc,QAAQ,EAAE;gBAC3C,MAAM,UAAU,IAAI,KAClB,cAAc,SAAS,CAAC,OAAO,KAAK,cAAc,QAAQ,GAAG;gBAE/D,IAAI,MAAM,SAAS;oBACjB,oCAAoC;oBACpC,MAAM,gIAAM,CAAC,OAAO,CAAC,MAAM,CAAC;wBAC1B,OAAO;4BAAE,IAAI,cAAc,EAAE;wBAAC;wBAC9B,MAAM;4BACJ,QAAQ;4BACR,SAAS;4BACT,gBAAgB,cAAc,QAAQ;wBACxC;oBACF;oBACA,sBAAsB;oBACtB,MAAM,QAAQ,GAAG,EAAE;gBACrB;YACF;QACF;QAEA,0BAA0B;QAC1B,MAAM,WAAW;YACf,QAAQ,OAAO,GAAG,CAAC,CAAC,QAAU,CAAC;oBAC7B,IAAI,MAAM,EAAE;oBACZ,SAAS,MAAM,OAAO;oBACtB,OAAO,MAAM,QAAQ,CAAC,MAAM,GAAG;gBACjC,CAAC;YACD,WAAW,KAAK,GAAG;QACrB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}