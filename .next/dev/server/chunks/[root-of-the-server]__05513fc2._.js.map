{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\nimport { withAccelerate } from \"@prisma/extension-accelerate\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: ReturnType<typeof createPrismaClient> | undefined;\n};\n\nfunction createPrismaClient() {\n  return new PrismaClient().$extends(withAccelerate());\n}\n\nexport const prisma = globalForPrisma.prisma ?? createPrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,kBAAkB;AAIxB,SAAS;IACP,OAAO,IAAI,sMAAY,GAAG,QAAQ,CAAC,IAAA,wLAAc;AACnD;AAEO,MAAM,SAAS,gBAAgB,MAAM,IAAI;AAEhD,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/lib/auth.ts"],"sourcesContent":["import NextAuth from \"next-auth\";\nimport Credentials from \"next-auth/providers/credentials\";\nimport bcrypt from \"bcryptjs\";\nimport { prisma } from \"./prisma\";\n\nexport const { handlers, signIn, signOut, auth } = NextAuth({\n  providers: [\n    Credentials({\n      name: \"credentials\",\n      credentials: {\n        email: { label: \"Email\", type: \"email\" },\n        password: { label: \"Password\", type: \"password\" },\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) {\n          return null;\n        }\n\n        const user = await prisma.user.findUnique({\n          where: { email: credentials.email as string },\n        });\n\n        if (!user) {\n          return null;\n        }\n\n        const isPasswordValid = await bcrypt.compare(\n          credentials.password as string,\n          user.password\n        );\n\n        if (!isPasswordValid) {\n          return null;\n        }\n\n        return {\n          id: user.id,\n          email: user.email,\n          name: user.name,\n        };\n      },\n    }),\n  ],\n  session: {\n    strategy: \"jwt\",\n  },\n  pages: {\n    signIn: \"/login\",\n  },\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        token.id = user.id;\n      }\n      return token;\n    },\n    async session({ session, token }) {\n      if (session.user) {\n        session.user.id = token.id as string;\n      }\n      return session;\n    },\n  },\n});\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AAAA;AACA;AACA;;;;;AAEO,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,IAAA,kKAAQ,EAAC;IAC1D,WAAW;QACT,IAAA,uKAAW,EAAC;YACV,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAQ;gBACvC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU;oBACjD,OAAO;gBACT;gBAEA,MAAM,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;oBACxC,OAAO;wBAAE,OAAO,YAAY,KAAK;oBAAW;gBAC9C;gBAEA,IAAI,CAAC,MAAM;oBACT,OAAO;gBACT;gBAEA,MAAM,kBAAkB,MAAM,8IAAM,CAAC,OAAO,CAC1C,YAAY,QAAQ,EACpB,KAAK,QAAQ;gBAGf,IAAI,CAAC,iBAAiB;oBACpB,OAAO;gBACT;gBAEA,OAAO;oBACL,IAAI,KAAK,EAAE;oBACX,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI;gBACjB;YACF;QACF;KACD;IACD,SAAS;QACP,UAAU;IACZ;IACA,OAAO;QACL,QAAQ;IACV;IACA,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE;YACpB;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;YAC5B;YACA,OAAO;QACT;IACF;AACF"}},
    {"offset": {"line": 158, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/lib/esp.ts"],"sourcesContent":["// Функции для управления ESP-12F\n\nconst ESP_TIMEOUT = 5000; // 5 секунд таймаут\n\nexport interface ESPCommandResult {\n  success: boolean;\n  error?: string;\n}\n\n// Отправить команду на ESP для включения/выключения света\nexport async function sendESPCommand(\n  espIpAddress: string,\n  gpioPin: number,\n  turnOn: boolean\n): Promise<ESPCommandResult> {\n  try {\n    const action = turnOn ? \"on\" : \"off\";\n    const url = `http://${espIpAddress}/control?pin=${gpioPin}&action=${action}`;\n\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), ESP_TIMEOUT);\n\n    const response = await fetch(url, {\n      method: \"GET\",\n      signal: controller.signal,\n    });\n\n    clearTimeout(timeoutId);\n\n    if (response.ok) {\n      return { success: true };\n    } else {\n      return {\n        success: false,\n        error: `ESP returned status ${response.status}`\n      };\n    }\n  } catch (error) {\n    if (error instanceof Error) {\n      if (error.name === \"AbortError\") {\n        return { success: false, error: \"Connection timeout\" };\n      }\n      return { success: false, error: error.message };\n    }\n    return { success: false, error: \"Unknown error\" };\n  }\n}\n\n// Включить свет на столе\nexport async function turnOnLight(\n  espIpAddress: string,\n  gpioPin: number\n): Promise<ESPCommandResult> {\n  console.log(`Turning ON light: ESP=${espIpAddress}, GPIO=${gpioPin}`);\n  return sendESPCommand(espIpAddress, gpioPin, true);\n}\n\n// Выключить свет на столе\nexport async function turnOffLight(\n  espIpAddress: string,\n  gpioPin: number\n): Promise<ESPCommandResult> {\n  console.log(`Turning OFF light: ESP=${espIpAddress}, GPIO=${gpioPin}`);\n  return sendESPCommand(espIpAddress, gpioPin, false);\n}\n"],"names":[],"mappings":";;;;;;;;AAAA,iCAAiC;AAEjC,MAAM,cAAc,MAAM,mBAAmB;AAQtC,eAAe,eACpB,YAAoB,EACpB,OAAe,EACf,MAAe;IAEf,IAAI;QACF,MAAM,SAAS,SAAS,OAAO;QAC/B,MAAM,MAAM,CAAC,OAAO,EAAE,aAAa,aAAa,EAAE,QAAQ,QAAQ,EAAE,QAAQ;QAE5E,MAAM,aAAa,IAAI;QACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI;QAEvD,MAAM,WAAW,MAAM,MAAM,KAAK;YAChC,QAAQ;YACR,QAAQ,WAAW,MAAM;QAC3B;QAEA,aAAa;QAEb,IAAI,SAAS,EAAE,EAAE;YACf,OAAO;gBAAE,SAAS;YAAK;QACzB,OAAO;YACL,OAAO;gBACL,SAAS;gBACT,OAAO,CAAC,oBAAoB,EAAE,SAAS,MAAM,EAAE;YACjD;QACF;IACF,EAAE,OAAO,OAAO;QACd,IAAI,iBAAiB,OAAO;YAC1B,IAAI,MAAM,IAAI,KAAK,cAAc;gBAC/B,OAAO;oBAAE,SAAS;oBAAO,OAAO;gBAAqB;YACvD;YACA,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;QAChD;QACA,OAAO;YAAE,SAAS;YAAO,OAAO;QAAgB;IAClD;AACF;AAGO,eAAe,YACpB,YAAoB,EACpB,OAAe;IAEf,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,aAAa,OAAO,EAAE,SAAS;IACpE,OAAO,eAAe,cAAc,SAAS;AAC/C;AAGO,eAAe,aACpB,YAAoB,EACpB,OAAe;IAEf,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,aAAa,OAAO,EAAE,SAAS;IACrE,OAAO,eAAe,cAAc,SAAS;AAC/C"}},
    {"offset": {"line": 220, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/app/api/sessions/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { auth } from \"@/lib/auth\";\nimport { turnOnLight } from \"@/lib/esp\";\n\n// GET /api/sessions - получить историю сессий\nexport async function GET(request: NextRequest) {\n  try {\n    const session = await auth();\n    if (!session) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const searchParams = request.nextUrl.searchParams;\n    const tableId = searchParams.get(\"tableId\");\n    const status = searchParams.get(\"status\");\n    const limit = parseInt(searchParams.get(\"limit\") || \"50\");\n    const offset = parseInt(searchParams.get(\"offset\") || \"0\");\n\n    const where: {\n      tableId?: number;\n      status?: \"ACTIVE\" | \"COMPLETED\" | \"EXPIRED\";\n    } = {};\n\n    if (tableId) {\n      where.tableId = parseInt(tableId);\n    }\n    if (status) {\n      where.status = status as \"ACTIVE\" | \"COMPLETED\" | \"EXPIRED\";\n    }\n\n    const [sessions, total] = await Promise.all([\n      prisma.session.findMany({\n        where,\n        include: {\n          table: {\n            select: { id: true, name: true, hourlyRate: true },\n          },\n        },\n        orderBy: { startedAt: \"desc\" },\n        take: limit,\n        skip: offset,\n      }),\n      prisma.session.count({ where }),\n    ]);\n\n    return NextResponse.json({ sessions, total, limit, offset });\n  } catch (error) {\n    console.error(\"Error fetching sessions:\", error);\n    return NextResponse.json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n\n// POST /api/sessions - начать новую сессию\nexport async function POST(request: NextRequest) {\n  try {\n    const authSession = await auth();\n    if (!authSession) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const body = await request.json();\n    const { tableId, duration } = body;\n\n    if (!tableId) {\n      return NextResponse.json(\n        { error: \"tableId is required\" },\n        { status: 400 }\n      );\n    }\n\n    // Проверяем существование стола\n    const table = await prisma.billiardTable.findUnique({\n      where: { id: tableId },\n    });\n\n    if (!table) {\n      return NextResponse.json({ error: \"Table not found\" }, { status: 404 });\n    }\n\n    // Проверяем нет ли активной сессии\n    const activeSession = await prisma.session.findFirst({\n      where: {\n        tableId,\n        status: \"ACTIVE\",\n      },\n    });\n\n    if (activeSession) {\n      return NextResponse.json(\n        { error: \"Table already has an active session\" },\n        { status: 400 }\n      );\n    }\n\n    // Создаём новую сессию с ценой стола на момент начала\n    const session = await prisma.session.create({\n      data: {\n        tableId,\n        duration: duration || null, // null = свободное время\n        hourlyRate: table.hourlyRate, // Сохраняем текущую цену стола\n        status: \"ACTIVE\",\n      },\n      include: {\n        table: {\n          select: { id: true, name: true, hourlyRate: true },\n        },\n      },\n    });\n\n    // Отправляем команду на ESP для включения света\n    const espResult = await turnOnLight(table.espIpAddress, table.gpioPin);\n    if (!espResult.success) {\n      console.error(`Failed to turn on light for table ${tableId}:`, espResult.error);\n    }\n\n    return NextResponse.json(session, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating session:\", error);\n    return NextResponse.json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}