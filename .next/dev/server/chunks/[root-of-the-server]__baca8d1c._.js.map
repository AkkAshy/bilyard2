{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\nimport { withAccelerate } from \"@prisma/extension-accelerate\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: ReturnType<typeof createPrismaClient> | undefined;\n};\n\nfunction createPrismaClient() {\n  return new PrismaClient().$extends(withAccelerate());\n}\n\nexport const prisma = globalForPrisma.prisma ?? createPrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,kBAAkB;AAIxB,SAAS;IACP,OAAO,IAAI,sMAAY,GAAG,QAAQ,CAAC,IAAA,wLAAc;AACnD;AAEO,MAAM,SAAS,gBAAgB,MAAM,IAAI;AAEhD,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/lib/auth.ts"],"sourcesContent":["import NextAuth from \"next-auth\";\nimport Credentials from \"next-auth/providers/credentials\";\nimport bcrypt from \"bcryptjs\";\nimport { prisma } from \"./prisma\";\n\nexport const { handlers, signIn, signOut, auth } = NextAuth({\n  providers: [\n    Credentials({\n      name: \"credentials\",\n      credentials: {\n        email: { label: \"Email\", type: \"email\" },\n        password: { label: \"Password\", type: \"password\" },\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) {\n          return null;\n        }\n\n        const user = await prisma.user.findUnique({\n          where: { email: credentials.email as string },\n        });\n\n        if (!user) {\n          return null;\n        }\n\n        const isPasswordValid = await bcrypt.compare(\n          credentials.password as string,\n          user.password\n        );\n\n        if (!isPasswordValid) {\n          return null;\n        }\n\n        return {\n          id: user.id,\n          email: user.email,\n          name: user.name,\n        };\n      },\n    }),\n  ],\n  session: {\n    strategy: \"jwt\",\n  },\n  pages: {\n    signIn: \"/login\",\n  },\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        token.id = user.id;\n      }\n      return token;\n    },\n    async session({ session, token }) {\n      if (session.user) {\n        session.user.id = token.id as string;\n      }\n      return session;\n    },\n  },\n});\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AAAA;AACA;AACA;;;;;AAEO,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,IAAA,kKAAQ,EAAC;IAC1D,WAAW;QACT,IAAA,uKAAW,EAAC;YACV,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAQ;gBACvC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU;oBACjD,OAAO;gBACT;gBAEA,MAAM,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;oBACxC,OAAO;wBAAE,OAAO,YAAY,KAAK;oBAAW;gBAC9C;gBAEA,IAAI,CAAC,MAAM;oBACT,OAAO;gBACT;gBAEA,MAAM,kBAAkB,MAAM,8IAAM,CAAC,OAAO,CAC1C,YAAY,QAAQ,EACpB,KAAK,QAAQ;gBAGf,IAAI,CAAC,iBAAiB;oBACpB,OAAO;gBACT;gBAEA,OAAO;oBACL,IAAI,KAAK,EAAE;oBACX,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI;gBACjB;YACF;QACF;KACD;IACD,SAAS;QACP,UAAU;IACZ;IACA,OAAO;QACL,QAAQ;IACV;IACA,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE;YACpB;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;YAC5B;YACA,OAAO;QACT;IACF;AACF"}},
    {"offset": {"line": 158, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/lib/esp.ts"],"sourcesContent":["// Функции для управления ESP-12F\n\nconst ESP_TIMEOUT = 5000; // 5 секунд таймаут\n\nexport interface ESPCommandResult {\n  success: boolean;\n  error?: string;\n}\n\n// Отправить команду на ESP для включения/выключения света\nexport async function sendESPCommand(\n  espIpAddress: string,\n  gpioPin: number,\n  turnOn: boolean\n): Promise<ESPCommandResult> {\n  try {\n    const action = turnOn ? \"on\" : \"off\";\n    const url = `http://${espIpAddress}/control?pin=${gpioPin}&action=${action}`;\n\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), ESP_TIMEOUT);\n\n    const response = await fetch(url, {\n      method: \"GET\",\n      signal: controller.signal,\n    });\n\n    clearTimeout(timeoutId);\n\n    if (response.ok) {\n      return { success: true };\n    } else {\n      return {\n        success: false,\n        error: `ESP returned status ${response.status}`\n      };\n    }\n  } catch (error) {\n    if (error instanceof Error) {\n      if (error.name === \"AbortError\") {\n        return { success: false, error: \"Connection timeout\" };\n      }\n      return { success: false, error: error.message };\n    }\n    return { success: false, error: \"Unknown error\" };\n  }\n}\n\n// Включить свет на столе\nexport async function turnOnLight(\n  espIpAddress: string,\n  gpioPin: number\n): Promise<ESPCommandResult> {\n  console.log(`Turning ON light: ESP=${espIpAddress}, GPIO=${gpioPin}`);\n  return sendESPCommand(espIpAddress, gpioPin, true);\n}\n\n// Выключить свет на столе\nexport async function turnOffLight(\n  espIpAddress: string,\n  gpioPin: number\n): Promise<ESPCommandResult> {\n  console.log(`Turning OFF light: ESP=${espIpAddress}, GPIO=${gpioPin}`);\n  return sendESPCommand(espIpAddress, gpioPin, false);\n}\n"],"names":[],"mappings":";;;;;;;;AAAA,iCAAiC;AAEjC,MAAM,cAAc,MAAM,mBAAmB;AAQtC,eAAe,eACpB,YAAoB,EACpB,OAAe,EACf,MAAe;IAEf,IAAI;QACF,MAAM,SAAS,SAAS,OAAO;QAC/B,MAAM,MAAM,CAAC,OAAO,EAAE,aAAa,aAAa,EAAE,QAAQ,QAAQ,EAAE,QAAQ;QAE5E,MAAM,aAAa,IAAI;QACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI;QAEvD,MAAM,WAAW,MAAM,MAAM,KAAK;YAChC,QAAQ;YACR,QAAQ,WAAW,MAAM;QAC3B;QAEA,aAAa;QAEb,IAAI,SAAS,EAAE,EAAE;YACf,OAAO;gBAAE,SAAS;YAAK;QACzB,OAAO;YACL,OAAO;gBACL,SAAS;gBACT,OAAO,CAAC,oBAAoB,EAAE,SAAS,MAAM,EAAE;YACjD;QACF;IACF,EAAE,OAAO,OAAO;QACd,IAAI,iBAAiB,OAAO;YAC1B,IAAI,MAAM,IAAI,KAAK,cAAc;gBAC/B,OAAO;oBAAE,SAAS;oBAAO,OAAO;gBAAqB;YACvD;YACA,OAAO;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC;QAChD;QACA,OAAO;YAAE,SAAS;YAAO,OAAO;QAAgB;IAClD;AACF;AAGO,eAAe,YACpB,YAAoB,EACpB,OAAe;IAEf,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,aAAa,OAAO,EAAE,SAAS;IACpE,OAAO,eAAe,cAAc,SAAS;AAC/C;AAGO,eAAe,aACpB,YAAoB,EACpB,OAAe;IAEf,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,aAAa,OAAO,EAAE,SAAS;IACrE,OAAO,eAAe,cAAc,SAAS;AAC/C"}},
    {"offset": {"line": 220, "column": 0}, "map": {"version":3,"sources":["file:///Users/akkanat/Projects/byiyard/src/app/api/sessions/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { auth } from \"@/lib/auth\";\nimport { turnOffLight } from \"@/lib/esp\";\n\n// Функция расчёта стоимости\nfunction calculateCost(durationMinutes: number, hourlyRate: number): number {\n  // Расчёт: (минуты / 60) * цена за час\n  // Округляем до целого числа сум\n  return Math.round((durationMinutes / 60) * hourlyRate);\n}\n\n// PUT /api/sessions/[id] - завершить сессию\nexport async function PUT(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const authSession = await auth();\n    if (!authSession) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const { id } = await params;\n    const body = await request.json();\n    const { action } = body;\n\n    if (action !== \"stop\") {\n      return NextResponse.json({ error: \"Invalid action\" }, { status: 400 });\n    }\n\n    // Находим сессию с информацией о столе\n    const existingSession = await prisma.session.findUnique({\n      where: { id },\n      include: {\n        table: true,\n      },\n    });\n\n    if (!existingSession) {\n      return NextResponse.json({ error: \"Session not found\" }, { status: 404 });\n    }\n\n    if (existingSession.status !== \"ACTIVE\") {\n      return NextResponse.json(\n        { error: \"Session is not active\" },\n        { status: 400 }\n      );\n    }\n\n    // Вычисляем фактическую продолжительность в минутах\n    const endedAt = new Date();\n    const actualDuration = Math.round(\n      (endedAt.getTime() - existingSession.startedAt.getTime()) / 60000\n    );\n\n    // Рассчитываем стоимость\n    const totalCost = calculateCost(actualDuration, existingSession.hourlyRate);\n\n    // Обновляем сессию\n    const session = await prisma.session.update({\n      where: { id },\n      data: {\n        status: \"COMPLETED\",\n        endedAt,\n        actualDuration,\n        totalCost,\n      },\n      include: {\n        table: {\n          select: { id: true, name: true, hourlyRate: true },\n        },\n      },\n    });\n\n    // Отправляем команду на ESP для выключения света\n    const espResult = await turnOffLight(\n      existingSession.table.espIpAddress,\n      existingSession.table.gpioPin\n    );\n    if (!espResult.success) {\n      console.error(\n        `Failed to turn off light for table ${existingSession.tableId}:`,\n        espResult.error\n      );\n    }\n\n    return NextResponse.json(session);\n  } catch (error) {\n    console.error(\"Error stopping session:\", error);\n    return NextResponse.json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA,4BAA4B;AAC5B,SAAS,cAAc,eAAuB,EAAE,UAAkB;IAChE,sCAAsC;IACtC,gCAAgC;IAChC,OAAO,KAAK,KAAK,CAAC,AAAC,kBAAkB,KAAM;AAC7C;AAGO,eAAe,IACpB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4HAAI;QAC9B,IAAI,CAAC,aAAa;YAChB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;QACrB,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,MAAM,EAAE,GAAG;QAEnB,IAAI,WAAW,QAAQ;YACrB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,uCAAuC;QACvC,MAAM,kBAAkB,MAAM,gIAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YACtD,OAAO;gBAAE;YAAG;YACZ,SAAS;gBACP,OAAO;YACT;QACF;QAEA,IAAI,CAAC,iBAAiB;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,IAAI,gBAAgB,MAAM,KAAK,UAAU;YACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAwB,GACjC;gBAAE,QAAQ;YAAI;QAElB;QAEA,oDAAoD;QACpD,MAAM,UAAU,IAAI;QACpB,MAAM,iBAAiB,KAAK,KAAK,CAC/B,CAAC,QAAQ,OAAO,KAAK,gBAAgB,SAAS,CAAC,OAAO,EAAE,IAAI;QAG9D,yBAAyB;QACzB,MAAM,YAAY,cAAc,gBAAgB,gBAAgB,UAAU;QAE1E,mBAAmB;QACnB,MAAM,UAAU,MAAM,gIAAM,CAAC,OAAO,CAAC,MAAM,CAAC;YAC1C,OAAO;gBAAE;YAAG;YACZ,MAAM;gBACJ,QAAQ;gBACR;gBACA;gBACA;YACF;YACA,SAAS;gBACP,OAAO;oBACL,QAAQ;wBAAE,IAAI;wBAAM,MAAM;wBAAM,YAAY;oBAAK;gBACnD;YACF;QACF;QAEA,iDAAiD;QACjD,MAAM,YAAY,MAAM,IAAA,mIAAY,EAClC,gBAAgB,KAAK,CAAC,YAAY,EAClC,gBAAgB,KAAK,CAAC,OAAO;QAE/B,IAAI,CAAC,UAAU,OAAO,EAAE;YACtB,QAAQ,KAAK,CACX,CAAC,mCAAmC,EAAE,gBAAgB,OAAO,CAAC,CAAC,CAAC,EAChE,UAAU,KAAK;QAEnB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}